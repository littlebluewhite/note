---
title: "q3640"
category: leetcode
tags: [leetcode]
created: 2026-02-04
updated: 2026-02-04
difficulty: Hard
source: leetcode
status: active
complexity_time: O(n)
complexity_space: O(n)  # using prefix sums; can be optimized
---
# q3640

[3640. Trionic Array II](https://leetcode.com/problems/trionic-array-ii/)

Hard

Topics

## Problem

You are given an integer array `nums` of length `n`.

A **trionic subarray** is a contiguous subarray `nums[l...r]` (with `0 <= l < r < n`) for which there exist indices `l < p < q < r` such that:

- `nums[l...p]` is **strictly increasing**,
- `nums[p...q]` is **strictly decreasing**,
- `nums[q...r]` is **strictly increasing**.

Return the **maximum sum** of any trionic subarray in `nums`.

---

給定整數陣列 `nums`（長度 `n`）。

**Trionic subarray**（三段單調子陣列）定義為一段連續子陣列 `nums[l...r]`（`0 <= l < r < n`），且存在 `l < p < q < r` 使得：

- `nums[l...p]` 嚴格遞增
- `nums[p...q]` 嚴格遞減
- `nums[q...r]` 嚴格遞增

回傳所有符合條件子陣列中 **總和最大** 的值。

## Examples

### Example 1

Input: `nums = [0,-2,-1,-3,0,2,-1]`

Output: `-4`

Explanation:
Pick `l = 1, p = 2, q = 3, r = 5`:
- `[-2, -1]` increasing
- `[-1, -3]` decreasing
- `[-3, 0, 2]` increasing
Sum = `-4`.

### Example 2

Input: `nums = [1,4,2,7]`

Output: `14`

Explanation:
Pick `l = 0, p = 1, q = 2, r = 3`.
Sum = `14`.

## Constraints

- `4 <= n = nums.length <= 10^5`
- `-10^9 <= nums[i] <= 10^9`
- It is guaranteed that at least one trionic subarray exists.

## 解題筆記與程式碼

核心想法（官方 editorial 的「Grouped Loop」直覺）：

1) 先用線性掃描把陣列切出「最大化」的三段單調結構：
   - 一段嚴格遞增 (inc1)
   - 一段嚴格遞減 (dec)
   - 一段嚴格遞增 (inc2)

   這段 maximal 的三相子陣列一旦確定後，下一個可能的三相子陣列只能從第三段的開頭繼續（所以整體仍然 `O(n)`）。

2) 對每個 maximal 三相片段，最大和會由：
   - 必選的最小合法三相子陣列（包含整段 dec + inc1 的尾端必要元素 + inc2 的前端必要元素）
   - 再加上「是否要往左在 inc1 多吃一些」與「是否要往右在 inc2 多吃一些」

   兩側延伸都可用 prefix sum + 最大前綴/後綴增益（若增益為負就不延伸，視為 0）來計算。

相關筆記：
- [Monotonic Three-Phase Scan (Inc→Dec→Inc)](../algorithm/monotonic_three_phase_scan.md)
- [Prefix Sum / 前綴和](../algorithm/prefix_sum.md)
- [Grouped Loop (Maximal Segment Enumeration)](../algorithm/grouped_loop_maximal_segments.md)

（程式碼略；依 editorial 的 grouped loop + prefix sums 實作即可。）
