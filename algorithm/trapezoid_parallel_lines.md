# Trapezoid Counting via Parallel Lines

目標：在最多 500 個平面點中，計算能形成「至少一組平行邊」的凸四邊形（梯形，含平行四邊形）的數量。

## 整體框架

- 先按「斜率」分族；同一族內的任兩條平行且不重合的直線，各取一條邊即可形成含平行邊的凸四邊形。
- 同斜率族的總數：對該族所有直線的邊數 `b_i = C(cnt_i, 2)`，套恆等式 `((Σ b_i)^2 - Σ b_i^2) / 2`。
- 平行四邊形在兩個斜率族都會被算一次，需要再扣除一次。

## 核心公式：同斜率族的梯形數

- 每條直線 i 的可用邊數 `b_i = C(cnt_i, 2)`，`cnt_i` 為該線上的點數（需 ≥2）。
- 族內總數 `Σ_{i<j} b_i * b_j`。用恆等式化簡：
  - 設 `S = Σ b_i`，則 `S^2 = Σ b_i^2 + 2 * Σ_{i<j} b_i * b_j`。
  - 移項得 `Σ_{i<j} b_i * b_j = (S^2 - Σ b_i^2) / 2`。
- 如此只要累計 `sum_b` 與 `sum_b2`，即可 O(m)（m 為該斜率族直線數）算出族內數量。

## 為何需要扣掉 `parallelograms`

- `total_parallel` 是「對每個斜率族各算一次」。平行四邊形有兩組平行邊，會在兩個斜率族各被計一次，總共 2 次；只有單組平行邊的梯形只會被計 1 次。
- 以對角線中點分組可得到平行四邊形數 `parallelograms`。將 `total_parallel - parallelograms`，就把平行四邊形的計數從 2 次修正為 1 次。

## 中點法計平行四邊形

- 平行四邊形的兩條對角線有共同中點且不平行。  
- 對每對點建立對角線，記錄：
  - 中點鍵：`(x1 + x2, y1 + y2)`（不用除 2）。
  - 方向：正規化斜率 `(dx/g, dy/g)`，方向固定 `dx>0` 或 `dx==0 && dy>0`。
- 對同一中點組：
  - 總對角線對數 `C(k, 2)`（k 為對角線條數）。
  - 扣掉平行的對數 `Σ C(cnt_dir, 2)`（按方向分組）。
  - 有效平行四邊形數 `= C(k, 2) - Σ C(cnt_dir, 2)`，對所有中點組累加即 `parallelograms`。

## 截距 key：`c = dy*x - dx*y`

- 方向向量 `(dx, dy)` 已正規化。直線上任意點 `(x, y)` 都滿足 `dy*x - dx*y = 常數`（即 `(x, y)` 與方向向量的叉積）。
- 沿直線平移 `(x + k*dx, y + k*dy)`，常數不變；平行但不重合的另一條線會得到不同的常數。
- 因此 `(normalized_slope, c)` 能唯一識別平行族中的一條直線，不用浮點或除法。

## 演算法步驟（精簡版）

1. 枚舉所有點對，依 `(normalized_slope, c)` 分組到 `lines`，並在每條線去重點索引；計算 `b = C(cnt, 2)`，累加該斜率族的 `sum_b`、`sum_b2`，用公式加到 `total_parallel`。
2. 再次枚舉點對，依中點分組，並記錄對角線方向。對每組計 `C(k, 2) - Σ C(cnt_dir, 2)`，累加成 `parallelograms`。
3. 答案 `= total_parallel - parallelograms`。

## 複雜度與實作細節

- 時間：O(n^2) 生成線與中點分組，後續統計為線性。
- 空間：O(n^2) 儲存線上點集合與中點到對角線方向的映射。
- 型別：計數用 `i64`；乘法暫用 `i128` 可避免溢位；座標、截距用 `i64`。
- 去重：線上的點索引 `sort_unstable + dedup`，避免同一直線的同一點重複。
- 凸性：兩條平行且不重合的直線，各取兩點天然形成凸四邊形；平行四邊形重複計數則用中點法修正。
