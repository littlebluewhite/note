# Horizontal Trapezoid Counting

目標：給定平面上一組點，計算能形成「兩條平行於 x 軸的邊」的凸四邊形（水平梯形）數量，答案取模 `1e9+7`。

## 題目重述與符號

- 點集合 `points = {(x, y)}`，同一條 y 直線上的點可構成水平邊。
- 若某條 y 線的點數為 `cnt`，可形成邊的數量 `b = C(cnt, 2) = cnt * (cnt - 1) / 2`。
- 所有可用邊記作 `{b_i}`。目標：`sum_{i<j} b_i * b_j (mod MOD)`，其中 `MOD = 1_000_000_007`，`inv2 = 500000004` 為 2 的反元素。

## 為什麼可行（完整推導）

1) 梯形結構  
   - 水平梯形必須有兩條平行於 x 軸的邊，且這兩條邊必定來自不同的 y 值直線，否則會變成退化的線段或三角形。  
   - 因此問題可拆成：先在每條 y 直線上挑出兩點形成「可用的水平邊」，再在兩條不同的 y 直線間，任意配對一條邊。

2) 抽象成組合數  
   - 對第 i 條 y 線，設該線上點數為 `cnt_i`，可形成的邊數 `b_i = C(cnt_i, 2)`（若 `cnt_i < 2` 則 `b_i = 0`，可忽略）。  
   - 兩條不同的 y 線 i、j 能形成的梯形數量是 `b_i * b_j`（任取一條邊自 i，再取一條邊自 j）。
   - 全部梯形總數：`Total = Σ_{i<j} b_i * b_j`。

3) 恆等式展開  
   - 令 `S = Σ b_i`，展開平方：`S^2 = (Σ b_i) * (Σ b_j) = Σ_i Σ_j b_i b_j`。  
   - 其中 `i = j` 的項是 `Σ b_i^2`；`i ≠ j` 的項每對 `(i, j)` 與 `(j, i)` 都會出現一次，所以等於 `2 * Σ_{i<j} b_i b_j`。因此 `S^2 = Σ b_i^2 + 2 * Σ_{i<j} b_i * b_j`。  
   - 例：`(b1 + b2 + b3)^2 = b1^2 + b2^2 + b3^2 + 2(b1b2 + b1b3 + b2b3)`，可直接看出對稱項被算了兩次。  
   - 移項得 `Σ_{i<j} b_i * b_j = (S^2 - Σ b_i^2) / 2`。這正是想要的總數。

4) 取模下的除以 2  
   - 在 `MOD` 下不能直接除以 2，改以乘法反元素 `inv2` 表示除 2：  
     `ans = ((S^2 - Σ b_i^2 + MOD) % MOD) * inv2 % MOD`。  
     先加 `MOD` 是為了避免 `S^2 - Σ b_i^2` 為負值。

## 步驟

1. 用 `HashMap<y, cnt>` 計次，每當 `cnt >= 2` 就算 `b = C(cnt, 2)`。
2. 同步累計 `sum_b = Σ b`、`sum_b2 = Σ b^2`（皆取模）。
3. 套公式：`ans = ((sum_b^2 - sum_b2 + MOD) % MOD) * inv2 % MOD`。

## 複雜度

- 時間：O(n + m)，n 為點數，m 為不同 y 數。
- 空間：O(m) 儲存各 y 的計數與中間組合值。

## 邊界情況與防呆

- 所有點在同一 y：`sum_b = 0` → 答案 0。
- 只有兩條 y 且皆至少 2 點：答案為 `b1 * b2`。
- 稀疏：大量 y 的 `cnt < 2`，需跳過避免汙染總和。
- 乘法/平方先升到 128 位再取模，避免溢位；減法後加 `MOD` 再 `% MOD` 防負值。

## 為何可用乘法反元素來「除以 2」

- 在模 `MOD` 下求 `x / 2`，等同找 `k` 使得 `2k ≡ x (mod MOD)`。只要 `gcd(2, MOD) = 1`，此方程有唯一解。`MOD = 1_000_000_007` 為質數，與 2 互質，因此解存在且唯一。
- 乘法反元素定義：`2 * inv2 ≡ 1 (mod MOD)`，所以 `k ≡ x * inv2 (mod MOD)` 即為所求。這等價於整數域中的除以 2。
- 算例：
  - `MOD=1_000_000_007`，`inv2=500000004`，驗證：`2 * inv2 % MOD = 1`。若 `x=5`，`k = 5 * inv2 % MOD = 500000006`，再檢查 `2 * k % MOD = 5`，成立。
  - 小模數驗證：`MOD=7`，`inv2=4`（因為 `2*4=8≡1 (mod 7)`）。若 `x=3`，則 `k=3*4 % 7 = 5`，檢查 `2*5 % 7 = 3`，成立。
## 小型測試集

- 單一 y：`[(0,0),(1,0),(2,0),(3,0)]` → 0。
- 兩條 y 各兩點：`[(0,0),(1,0),(0,1),(1,1)]` → `1*1 = 1`。
- 範例 1：y=0 有 3 點 → 3，y=2 有 2 點 → 1，乘積 3。
- 混合稀疏：`[(0,0),(1,0),(0,2),(1,3)]`（只有 y=0 有 2 點）→ 0。
- 壓力：單條 y 有 1e5 點 → 0；兩條 y 各 1e5 點 → `C(1e5,2)^2 mod MOD`。

## 相關/延伸

- 常用恒等式：`sum_{i<j} a_i a_j = ((sum a)^2 - sum a^2) / 2`。
- 可延伸到任意平行邊方向：先按斜率分組算 `C(cnt, 2)`，再以同式計算兩兩乘積（需額外考慮凸性/共線重疊）。  
